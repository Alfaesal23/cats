<html><head><title>Cats: FreeApplicatives</title><meta charset="utf-8" /><meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" /><meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="author" content="Cats contributors" /><meta name="description" content="Lightweight, modular, and extensible library for functional programming" /><meta name="og:image" content="/cats/img/poster.png" /><meta name="og:title" content="Cats: FreeApplicatives" /><meta name="og:site_name" content="Cats" /><meta name="og:url" content="http://typelevel.org/cats/" /><meta name="og:type" content="website" /><meta name="og:description" content="Lightweight, modular, and extensible library for functional programming" /><link rel="icon" type="image/png" href="/cats/img/favicon.png" /><meta name="twitter:title" content="Cats: FreeApplicatives" /><meta name="twitter:image" content="http://typelevel.org/cats/img/poster.png" /><meta name="twitter:description" content="Lightweight, modular, and extensible library for functional programming" /><meta name="twitter:card" content="summary_large_image" /><link rel="icon" type="image/png" sizes="16x16" href="/cats/img/favicon16x16.png" /><link rel="icon" type="image/png" sizes="24x24" href="/cats/img/favicon24x24.png" /><link rel="icon" type="image/png" sizes="32x32" href="/cats/img/favicon32x32.png" /><link rel="icon" type="image/png" sizes="48x48" href="/cats/img/favicon48x48.png" /><link rel="icon" type="image/png" sizes="57x57" href="/cats/img/favicon57x57.png" /><link rel="icon" type="image/png" sizes="60x60" href="/cats/img/favicon60x60.png" /><link rel="icon" type="image/png" sizes="64x64" href="/cats/img/favicon64x64.png" /><link rel="icon" type="image/png" sizes="70x70" href="/cats/img/favicon70x70.png" /><link rel="icon" type="image/png" sizes="72x72" href="/cats/img/favicon72x72.png" /><link rel="icon" type="image/png" sizes="76x76" href="/cats/img/favicon76x76.png" /><link rel="icon" type="image/png" sizes="96x96" href="/cats/img/favicon96x96.png" /><link rel="icon" type="image/png" sizes="114x114" href="/cats/img/favicon114x114.png" /><link rel="icon" type="image/png" sizes="120x120" href="/cats/img/favicon120x120.png" /><link rel="icon" type="image/png" sizes="128x128" href="/cats/img/favicon128x128.png" /><link rel="icon" type="image/png" sizes="144x144" href="/cats/img/favicon144x144.png" /><link rel="icon" type="image/png" sizes="150x150" href="/cats/img/favicon150x150.png" /><link rel="icon" type="image/png" sizes="152x152" href="/cats/img/favicon152x152.png" /><link rel="icon" type="image/png" sizes="196x196" href="/cats/img/favicon196x196.png" /><link rel="icon" type="image/png" sizes="310x310" href="/cats/img/favicon310x310.png" /><link rel="icon" type="image/png" sizes="310x150" href="/cats/img/favicon310x150.png" /><link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" /><link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" /><link rel="stylesheet" href="/cats/highlight/styles/atom-one-light.css" /><link rel="stylesheet" href="/cats/css/style.css" /><link rel="stylesheet" href="/cats/css/palette.css" /><link rel="stylesheet" href="/cats/css/codemirror.css" /><link rel="stylesheet" href="/cats/css/override.css" /></head><body class="docs"><div id="wrapper"><div id="sidebar-wrapper"><ul id="sidebar" class="sidebar-nav"><li class="sidebar-brand"><a href="/cats/" class="brand"><div class="brand-wrapper"><span>Cats</span></div></a></li>                <li><a href="/cats/datatypes.html" class="">Data Types</a></li> <li><a href="/cats/datatypes/const.html" class="">Const</a></li> <li><a href="/cats/datatypes/either.html" class="">Either</a></li> <li><a href="/cats/datatypes/eval.html" class="">Eval</a></li> <li><a href="/cats/datatypes/freeapplicative.html" class=" active ">FreeApplicatives</a></li> <li><a href="/cats/datatypes/freemonad.html" class="">FreeMonads</a></li> <li><a href="/cats/datatypes/functionk.html" class="">FunctionK</a></li> <li><a href="/cats/datatypes/id.html" class="">Id</a></li> <li><a href="/cats/datatypes/ior.html" class="">Ior</a></li> <li><a href="/cats/datatypes/kleisli.html" class="">Kleisli</a></li> <li><a href="/cats/datatypes/nested.html" class="">Nested</a></li> <li><a href="/cats/datatypes/nel.html" class="">NonEmptyList</a></li> <li><a href="/cats/datatypes/oneand.html" class="">OneAnd</a></li> <li><a href="/cats/datatypes/optiont.html" class="">OptionT</a></li> <li><a href="/cats/datatypes/eithert.html" class="">EitherT</a></li> <li><a href="/cats/datatypes/iort.html" class="">IorT</a></li> <li><a href="/cats/datatypes/state.html" class="">State</a></li> <li><a href="/cats/datatypes/validated.html" class="">Validated</a></li></ul></div><div id="page-content-wrapper"><div class="nav"><div class="container-fluid"><div class="row"><div class="col-lg-12"><div class="action-menu pull-left clearfix"><a href="#menu-toggle" id="menu-toggle"><i class="fa fa-bars" aria-hidden="true"></i></a></div><ul class="pull-right"><li id="gh-eyes-item" class="hidden-xs"><a href="https://github.com/typelevel/cats"><i class="fa fa-eye"></i><span>WATCH<span id="eyes" class="label label-default">--</span></span></a></li><li id="gh-stars-item" class="hidden-xs"><a href="https://github.com/typelevel/cats"><i class="fa fa-star-o"></i><span>STARS<span id="stars" class="label label-default">--</span></span></a></li><li><a href="#" onclick="shareSiteTwitter('Cats Lightweight, modular, and extensible library for functional programming');"><i class="fa fa-twitter"></i></a></li><li><a href="#" onclick="shareSiteFacebook('Cats Lightweight, modular, and extensible library for functional programming');"><i class="fa fa-facebook"></i></a></li><li><a href="#" onclick="shareSiteGoogle();"><i class="fa fa-google-plus"></i></a></li></ul></div></div></div></div><div id="content" data-github-owner="typelevel" data-github-repo="cats"><div class="content-wrapper"><section><h1 id="free-applicative">Free Applicative</h1>

<p><code class="highlighter-rouge">FreeApplicative</code>s are similar to <code class="highlighter-rouge">Free</code> (monads) in that they provide a nice way to represent
computations as data and are useful for building embedded DSLs (EDSLs). However, they differ
from <code class="highlighter-rouge">Free</code> in that the kinds of operations they support are limited, much like the distinction
between <code class="highlighter-rouge">Applicative</code> and <code class="highlighter-rouge">Monad</code>.</p>

<h2 id="dependency">Dependency</h2>

<p>If you’d like to use cats’ free applicative, you’ll need to add a library dependency
for the <code class="highlighter-rouge">cats-free</code> module.</p>

<h2 id="example">Example</h2>
<p>Consider building an EDSL for validating strings - to keep things simple we’ll just have
a way to check a string is at least a certain size and to ensure the string contains numbers.</p>

<div class="language-scala highlighter-rouge"><pre class="highlight"><code><span class="k">sealed</span> <span class="k">abstract</span> <span class="k">class</span> <span class="nc">ValidationOp</span><span class="o">[</span><span class="kt">A</span><span class="o">]</span>
<span class="nc">case</span> <span class="k">class</span> <span class="nc">Size</span><span class="o">(</span><span class="n">size</span><span class="k">:</span> <span class="kt">Int</span><span class="o">)</span> <span class="k">extends</span> <span class="nc">ValidationOp</span><span class="o">[</span><span class="kt">Boolean</span><span class="o">]</span>
<span class="k">case</span> <span class="k">object</span> <span class="nc">HasNumber</span> <span class="k">extends</span> <span class="nc">ValidationOp</span><span class="o">[</span><span class="kt">Boolean</span><span class="o">]</span>
</code></pre>
</div>

<p>Much like the <code class="highlighter-rouge">Free</code> monad tutorial, we use smart constructors to lift our algebra into the <code class="highlighter-rouge">FreeApplicative</code>.</p>

<div class="language-scala highlighter-rouge"><pre class="highlight"><code><span class="k">import</span> <span class="nn">cats.free.FreeApplicative</span>
<span class="k">import</span> <span class="nn">cats.free.FreeApplicative.lift</span>

<span class="k">type</span> <span class="kt">Validation</span><span class="o">[</span><span class="kt">A</span><span class="o">]</span> <span class="k">=</span> <span class="nc">FreeApplicative</span><span class="o">[</span><span class="kt">ValidationOp</span>, <span class="kt">A</span><span class="o">]</span>

<span class="k">def</span> <span class="n">size</span><span class="o">(</span><span class="n">size</span><span class="k">:</span> <span class="kt">Int</span><span class="o">)</span><span class="k">:</span> <span class="kt">Validation</span><span class="o">[</span><span class="kt">Boolean</span><span class="o">]</span> <span class="k">=</span> <span class="n">lift</span><span class="o">(</span><span class="nc">Size</span><span class="o">(</span><span class="n">size</span><span class="o">))</span>

<span class="k">val</span> <span class="n">hasNumber</span><span class="k">:</span> <span class="kt">Validation</span><span class="o">[</span><span class="kt">Boolean</span><span class="o">]</span> <span class="k">=</span> <span class="n">lift</span><span class="o">(</span><span class="nc">HasNumber</span><span class="o">)</span>
</code></pre>
</div>

<p>Because a <code class="highlighter-rouge">FreeApplicative</code> only supports the operations of <code class="highlighter-rouge">Applicative</code>, we do not get the nicety
of a for-comprehension. We can however still use <code class="highlighter-rouge">Applicative</code> syntax provided by Cats.</p>

<div class="language-scala highlighter-rouge"><pre class="highlight"><code><span class="k">import</span> <span class="nn">cats.implicits._</span>

<span class="k">val</span> <span class="n">prog</span><span class="k">:</span> <span class="kt">Validation</span><span class="o">[</span><span class="kt">Boolean</span><span class="o">]</span> <span class="k">=</span> <span class="o">(</span><span class="n">size</span><span class="o">(</span><span class="mi">5</span><span class="o">),</span> <span class="n">hasNumber</span><span class="o">).</span><span class="n">mapN</span> <span class="o">{</span> <span class="k">case</span> <span class="o">(</span><span class="n">l</span><span class="o">,</span> <span class="n">r</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="n">l</span> <span class="o">&amp;&amp;</span> <span class="n">r</span><span class="o">}</span>
</code></pre>
</div>

<p>As it stands, our program is just an instance of a data structure - nothing has happened
at this point. To make our program useful we need to interpret it.</p>

<div class="language-scala highlighter-rouge"><pre class="highlight"><code><span class="k">import</span> <span class="nn">cats.Id</span>
<span class="k">import</span> <span class="nn">cats.arrow.FunctionK</span>
<span class="k">import</span> <span class="nn">cats.implicits._</span>

<span class="c1">// a function that takes a string as input
</span><span class="k">type</span> <span class="kt">FromString</span><span class="o">[</span><span class="kt">A</span><span class="o">]</span> <span class="k">=</span> <span class="nc">String</span> <span class="k">=&gt;</span> <span class="n">A</span>

<span class="k">val</span> <span class="n">compiler</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">FunctionK</span><span class="o">[</span><span class="kt">ValidationOp</span>, <span class="kt">FromString</span><span class="o">]</span> <span class="o">{</span>
  <span class="k">def</span> <span class="n">apply</span><span class="o">[</span><span class="kt">A</span><span class="o">](</span><span class="n">fa</span><span class="k">:</span> <span class="kt">ValidationOp</span><span class="o">[</span><span class="kt">A</span><span class="o">])</span><span class="k">:</span> <span class="kt">FromString</span><span class="o">[</span><span class="kt">A</span><span class="o">]</span> <span class="k">=</span> <span class="n">str</span> <span class="k">=&gt;</span>
    <span class="n">fa</span> <span class="k">match</span> <span class="o">{</span>
      <span class="k">case</span> <span class="nc">Size</span><span class="o">(</span><span class="n">size</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="n">str</span><span class="o">.</span><span class="n">size</span> <span class="o">&gt;=</span> <span class="n">size</span>
      <span class="k">case</span> <span class="nc">HasNumber</span>  <span class="k">=&gt;</span> <span class="n">str</span><span class="o">.</span><span class="n">exists</span><span class="o">(</span><span class="n">c</span> <span class="k">=&gt;</span> <span class="s">"0123456789"</span><span class="o">.</span><span class="n">contains</span><span class="o">(</span><span class="n">c</span><span class="o">))</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre>
</div>

<div class="language-scala highlighter-rouge"><pre class="highlight"><code><span class="k">val</span> <span class="n">validator</span> <span class="k">=</span> <span class="n">prog</span><span class="o">.</span><span class="n">foldMap</span><span class="o">[</span><span class="kt">FromString</span><span class="o">](</span><span class="n">compiler</span><span class="o">)</span>
<span class="c1">// validator: FromString[Boolean] = cats.instances.Function1Instances$$anon$2$$Lambda$12533/1906691532@7cea9806
</span>
<span class="n">validator</span><span class="o">(</span><span class="s">"1234"</span><span class="o">)</span>
<span class="c1">// res1: Boolean = false
</span>
<span class="n">validator</span><span class="o">(</span><span class="s">"12345"</span><span class="o">)</span>
<span class="c1">// res2: Boolean = true
</span></code></pre>
</div>

<h2 id="differences-from-free">Differences from <code class="highlighter-rouge">Free</code></h2>
<p>So far everything we’ve been doing has been not much different from <code class="highlighter-rouge">Free</code> - we’ve built
an algebra and interpreted it. However, there are some things <code class="highlighter-rouge">FreeApplicative</code> can do that
<code class="highlighter-rouge">Free</code> cannot.</p>

<p>Recall a key distinction between the type classes <code class="highlighter-rouge">Applicative</code> and <code class="highlighter-rouge">Monad</code> - <code class="highlighter-rouge">Applicative</code>
captures the idea of independent computations, whereas <code class="highlighter-rouge">Monad</code> captures that of dependent
computations. Put differently <code class="highlighter-rouge">Applicative</code>s cannot branch based on the value of an existing/prior
computation. Therefore when using <code class="highlighter-rouge">Applicative</code>s, we must hand in all our data in one go.</p>

<p>In the context of <code class="highlighter-rouge">FreeApplicative</code>s, we can leverage this static knowledge in our interpreter.</p>

<h3 id="parallelism">Parallelism</h3>
<p>Because we have everything we need up front and know there can be no branching, we can easily
write a validator that validates in parallel.</p>

<div class="language-scala highlighter-rouge"><pre class="highlight"><code><span class="k">import</span> <span class="nn">cats.data.Kleisli</span>
<span class="k">import</span> <span class="nn">cats.implicits._</span>
<span class="k">import</span> <span class="nn">scala.concurrent.Future</span>
<span class="k">import</span> <span class="nn">scala.concurrent.ExecutionContext.Implicits.global</span>

<span class="c1">// recall Kleisli[Future, String, A] is the same as String =&gt; Future[A]
</span><span class="k">type</span> <span class="kt">ParValidator</span><span class="o">[</span><span class="kt">A</span><span class="o">]</span> <span class="k">=</span> <span class="nc">Kleisli</span><span class="o">[</span><span class="kt">Future</span>, <span class="kt">String</span>, <span class="kt">A</span><span class="o">]</span>

<span class="k">val</span> <span class="n">parCompiler</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">FunctionK</span><span class="o">[</span><span class="kt">ValidationOp</span>, <span class="kt">ParValidator</span><span class="o">]</span> <span class="o">{</span>
  <span class="k">def</span> <span class="n">apply</span><span class="o">[</span><span class="kt">A</span><span class="o">](</span><span class="n">fa</span><span class="k">:</span> <span class="kt">ValidationOp</span><span class="o">[</span><span class="kt">A</span><span class="o">])</span><span class="k">:</span> <span class="kt">ParValidator</span><span class="o">[</span><span class="kt">A</span><span class="o">]</span> <span class="k">=</span> <span class="nc">Kleisli</span> <span class="o">{</span> <span class="n">str</span> <span class="k">=&gt;</span>
    <span class="n">fa</span> <span class="k">match</span> <span class="o">{</span>
      <span class="k">case</span> <span class="nc">Size</span><span class="o">(</span><span class="n">size</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="nc">Future</span> <span class="o">{</span> <span class="n">str</span><span class="o">.</span><span class="n">size</span> <span class="o">&gt;=</span> <span class="n">size</span> <span class="o">}</span>
      <span class="k">case</span> <span class="nc">HasNumber</span> <span class="k">=&gt;</span> <span class="nc">Future</span> <span class="o">{</span> <span class="n">str</span><span class="o">.</span><span class="n">exists</span><span class="o">(</span><span class="n">c</span> <span class="k">=&gt;</span> <span class="s">"0123456789"</span><span class="o">.</span><span class="n">contains</span><span class="o">(</span><span class="n">c</span><span class="o">))</span> <span class="o">}</span>
    <span class="o">}</span>
  <span class="o">}</span>
<span class="o">}</span>

<span class="k">val</span> <span class="n">parValidator</span> <span class="k">=</span> <span class="n">prog</span><span class="o">.</span><span class="n">foldMap</span><span class="o">[</span><span class="kt">ParValidator</span><span class="o">](</span><span class="n">parCompiler</span><span class="o">)</span>
</code></pre>
</div>

<h3 id="logging">Logging</h3>
<p>We can also write an interpreter that simply creates a list of strings indicating the filters that
have been used - this could be useful for logging purposes. Note that we need not actually evaluate
the rules against a string for this, we simply need to map each rule to some identifier. Therefore
we can completely ignore the return type of the operation and return just a <code class="highlighter-rouge">List[String]</code> - the
<code class="highlighter-rouge">Const</code> data type is useful for this.</p>

<div class="language-scala highlighter-rouge"><pre class="highlight"><code><span class="k">import</span> <span class="nn">cats.data.Const</span>
<span class="k">import</span> <span class="nn">cats.implicits._</span>

<span class="k">type</span> <span class="kt">Log</span><span class="o">[</span><span class="kt">A</span><span class="o">]</span> <span class="k">=</span> <span class="nc">Const</span><span class="o">[</span><span class="kt">List</span><span class="o">[</span><span class="kt">String</span><span class="o">]</span>, <span class="kt">A</span><span class="o">]</span>

<span class="k">val</span> <span class="n">logCompiler</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">FunctionK</span><span class="o">[</span><span class="kt">ValidationOp</span>, <span class="kt">Log</span><span class="o">]</span> <span class="o">{</span>
  <span class="k">def</span> <span class="n">apply</span><span class="o">[</span><span class="kt">A</span><span class="o">](</span><span class="n">fa</span><span class="k">:</span> <span class="kt">ValidationOp</span><span class="o">[</span><span class="kt">A</span><span class="o">])</span><span class="k">:</span> <span class="kt">Log</span><span class="o">[</span><span class="kt">A</span><span class="o">]</span> <span class="k">=</span> <span class="n">fa</span> <span class="k">match</span> <span class="o">{</span>
    <span class="k">case</span> <span class="nc">Size</span><span class="o">(</span><span class="n">size</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="nc">Const</span><span class="o">(</span><span class="nc">List</span><span class="o">(</span><span class="n">s</span><span class="s">"size &gt;= $size"</span><span class="o">))</span>
    <span class="k">case</span> <span class="nc">HasNumber</span> <span class="k">=&gt;</span> <span class="nc">Const</span><span class="o">(</span><span class="nc">List</span><span class="o">(</span><span class="s">"has number"</span><span class="o">))</span>
  <span class="o">}</span>
<span class="o">}</span>

<span class="k">def</span> <span class="n">logValidation</span><span class="o">[</span><span class="kt">A</span><span class="o">](</span><span class="n">validation</span><span class="k">:</span> <span class="kt">Validation</span><span class="o">[</span><span class="kt">A</span><span class="o">])</span><span class="k">:</span> <span class="kt">List</span><span class="o">[</span><span class="kt">String</span><span class="o">]</span> <span class="k">=</span>
  <span class="n">validation</span><span class="o">.</span><span class="n">foldMap</span><span class="o">[</span><span class="kt">Log</span><span class="o">](</span><span class="n">logCompiler</span><span class="o">).</span><span class="n">getConst</span>
</code></pre>
</div>

<div class="language-scala highlighter-rouge"><pre class="highlight"><code><span class="n">logValidation</span><span class="o">(</span><span class="n">prog</span><span class="o">)</span>
<span class="c1">// res4: List[String] = List(size &gt;= 5, has number)
</span>
<span class="n">logValidation</span><span class="o">(</span><span class="n">size</span><span class="o">(</span><span class="mi">5</span><span class="o">)</span> <span class="o">*&gt;</span> <span class="n">hasNumber</span> <span class="o">*&gt;</span> <span class="n">size</span><span class="o">(</span><span class="mi">10</span><span class="o">))</span>
<span class="c1">// res5: List[String] = List(size &gt;= 5, has number, size &gt;= 10)
</span>
<span class="n">logValidation</span><span class="o">((</span><span class="n">hasNumber</span><span class="o">,</span> <span class="n">size</span><span class="o">(</span><span class="mi">3</span><span class="o">)).</span><span class="n">mapN</span><span class="o">(</span><span class="k">_</span> <span class="o">||</span> <span class="k">_</span><span class="o">))</span>
<span class="c1">// res6: List[String] = List(has number, size &gt;= 3)
</span></code></pre>
</div>

<h3 id="why-not-both">Why not both?</h3>
<p>It is perhaps more plausible and useful to have both the actual validation function and the logging
strings. While we could easily compile our program twice, once for each interpreter as we have above,
we could also do it in one go - this would avoid multiple traversals of the same structure.</p>

<p>Another useful property <code class="highlighter-rouge">Applicative</code>s have over <code class="highlighter-rouge">Monad</code>s is that given two <code class="highlighter-rouge">Applicative</code>s <code class="highlighter-rouge">F[_]</code> and
<code class="highlighter-rouge">G[_]</code>, their product <code class="highlighter-rouge">type FG[A] = (F[A], G[A])</code> is also an <code class="highlighter-rouge">Applicative</code>. This is not true in the general
case for monads.</p>

<p>Therefore, we can write an interpreter that uses the product of the <code class="highlighter-rouge">ParValidator</code> and <code class="highlighter-rouge">Log</code> <code class="highlighter-rouge">Applicative</code>s
to interpret our program in one go. We can create this interpreter easily by using <code class="highlighter-rouge">FunctionK#and</code>.</p>

<div class="language-scala highlighter-rouge"><pre class="highlight"><code><span class="k">import</span> <span class="nn">cats.data.Tuple2K</span>

<span class="k">type</span> <span class="kt">ValidateAndLog</span><span class="o">[</span><span class="kt">A</span><span class="o">]</span> <span class="k">=</span> <span class="nc">Tuple2K</span><span class="o">[</span><span class="kt">ParValidator</span>, <span class="kt">Log</span>, <span class="kt">A</span><span class="o">]</span>

<span class="k">val</span> <span class="n">prodCompiler</span><span class="k">:</span> <span class="kt">FunctionK</span><span class="o">[</span><span class="kt">ValidationOp</span>, <span class="kt">ValidateAndLog</span><span class="o">]</span> <span class="k">=</span> <span class="n">parCompiler</span> <span class="n">and</span> <span class="n">logCompiler</span>

<span class="k">val</span> <span class="n">prodValidation</span> <span class="k">=</span> <span class="n">prog</span><span class="o">.</span><span class="n">foldMap</span><span class="o">[</span><span class="kt">ValidateAndLog</span><span class="o">](</span><span class="n">prodCompiler</span><span class="o">)</span>
</code></pre>
</div>

<h3 id="the-way-freeapplicativefoldmap-works">The way FreeApplicative#foldMap works</h3>
<p>Despite being an imperative loop, there is a functional intuition behind <code class="highlighter-rouge">FreeApplicative#foldMap</code>.</p>

<p>The new <code class="highlighter-rouge">FreeApplicative</code>’s <code class="highlighter-rouge">foldMap</code> is a sort of mutually-recursive function that operates on an argument stack and a 
function stack, where the argument stack has type <code class="highlighter-rouge">List[FreeApplicative[F, _]]</code> and the functions have type <code class="highlighter-rouge">List[Fn[G, _, _]]</code>.
<code class="highlighter-rouge">Fn[G[_, _]]</code> contains a function to be <code class="highlighter-rouge">Ap</code>‘d that has already been translated to the target <code class="highlighter-rouge">Applicative</code>,
as well as the number of functions that were <code class="highlighter-rouge">Ap</code>‘d immediately subsequently to it.</p>

<h4 id="main-re-association-loop">Main re-association loop</h4>
<p>Pull an argument out of the stack, eagerly remove right-associated <code class="highlighter-rouge">Ap</code> nodes, by looping on the right and 
adding the <code class="highlighter-rouge">Ap</code> nodes’ arguments on the left to the argument stack; at the end, pushes a single function to the 
function stack of the applied functions, the rest of which will be pushed in this loop in later iterations. 
Once all of the <code class="highlighter-rouge">Ap</code> nodes on the right are removed, the loop resets to deal with the ones on the left.</p>

<p>Here’s an example <code class="highlighter-rouge">FreeApplicative</code> value to demonstrate the loop’s function, at the end of every iteration.
Every node in the tree is annotated with an identifying number and the concrete type of the node
(A -&gt; <code class="highlighter-rouge">Ap</code>, L -&gt; <code class="highlighter-rouge">Lift</code>, P -&gt; <code class="highlighter-rouge">Pure</code>), and an apostrophe to denote where <code class="highlighter-rouge">argF</code> (the current argument) currently
points; as well the argument and function branches off <code class="highlighter-rouge">Ap</code> nodes are explicitly denoted.</p>

<div class="highlighter-rouge"><pre class="highlight"><code>==&gt; begin.
           '1A
           /  \
       arg/    \fun
         /      \
        /        \
       2A        3A
   arg/  \fun arg/  \fun
     /    \     /    \
    4L    5P   6L     7L

args: Nil
functions: Nil
==&gt; loop.

            1A
           /  \
       arg/    \fun
         /      \
        /        \
       2A        '3A
   arg/  \fun arg/  \fun
     /    \     /    \
    4L    5P   6L    7L

args: 2A :: Nil
functions: Nil
==&gt; loop.

            1A
           /  \
       arg/    \fun
         /      \
        /        \
       2A         3A
   arg/  \fun arg/  \fun
     /    \     /    \
    4L    5P   6L   '7L

args: 6L :: 2A :: Nil
functions: Fn(gab = foldArg(7L), argc = 2) :: Nil
==&gt; finished.
</code></pre>
</div>

<p>At the end of the loop the entire right branch of <code class="highlighter-rouge">Ap</code>s under <code class="highlighter-rouge">argF</code> has been peeled off into a single curried function,
all of the arguments to that function are on the argument stack and that function itself is on the function stack,
annotated with the amount of arguments it takes.</p>

<h4 id="function-application-loop">Function application loop</h4>
<p>Once <code class="highlighter-rouge">argF</code> isn’t an <code class="highlighter-rouge">Ap</code> node, a loop runs which pulls functions from the stack until it reaches a curried function,
in which case it applies the function to <code class="highlighter-rouge">argF</code> transformed into a <code class="highlighter-rouge">G[Any]</code> value, and pushes the resulting function
back to the function stack, before returning to the main loop.</p>

<p>I’ll continue the example from before here:</p>
<div class="highlighter-rouge"><pre class="highlight"><code>==&gt; loop.
            1A
           /  \
       arg/    \fun
         /      \
        /        \
       2A         3A
   arg/  \fun arg/  \fun
     /    \     /    \
    4L    5P  '6L    7L

args: 2A :: Nil
functions: Fn(gab = foldArg(7L) ap foldArg(6L), argc = 1) :: Nil
==&gt; finished.
</code></pre>
</div>

<p>At the end of this loop every function on the top of the function stack with <code class="highlighter-rouge">length == 1</code> (not curried)
has been applied to a single argument from the argument stack, and the first curried function (<code class="highlighter-rouge">length != 1</code>)
on the stack has been applied to a single argument from the argument stack.
The reason we can’t keep applying the curried function to arguments is that the node on top of the argument
stack <em>must</em> be an <code class="highlighter-rouge">Ap</code> node if the function is curried, so we can’t translate it directly to <code class="highlighter-rouge">G[_]</code>.</p>

<p>Once the last function has been applied to the last argument, the fold has finished and the result is returned.</p>

<h2 id="references">References</h2>
<p>Deeper explanations can be found in this paper <a href="http://www.paolocapriotti.com/assets/applicative.pdf">Free Applicative Functors by Paolo Capriotti</a></p>
</section></div></div></div></div><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/js/bootstrap.min.js"></script><script src="/cats/highlight/highlight.pack.js"></script><script>hljs.configure({
languages:['scala','java','bash']
});
hljs.initHighlighting();
             </script><script>((window.gitter = {}).chat = {}).options = {
room: 'typelevel/cats'};</script><script src="https://sidecar.gitter.im/dist/sidecar.v1.js"></script><script src="/cats/js/main.js"></script></body></html>